# RadField3D: A generator for spatially resolved x-ray radiation fields using Geant4
This repository contains the code of the monte-carlo simulation application presented by our [Paper](https://arxiv.org/abs/2412.13852) that we call RadField3D. This application aims to simulate a concentric x-ray beam, that can be rotated on a sphere with a certain radius around the center of the irradiated scene. RadField3D stores the radiation fields spatially resolved in an efficiently machine readable and interpretable file format that we refer to as RadFiled3D. The code of that file format is located [here](https://github.com/Centrasis/RadFiled3D). Thanks to the Python API and pyTorch Integration, this application and RadFiled3D is suited to be used in machine learning. Therefore, RadFiled3D can be directly installed from PyPi using pip.

## Table of Contents
- [Getting Started](#getting-started)
  - [Installing from Source](#installing-from-source)
    - [Prerequisites](#prerequisites)
- [Generating Datasets](#generating-datasets)
  - [Directly using RadField3D](#directly-using-radfield3d)
    - [Geometry world description file](#geometry-world-description-file)
  - [Using the DatasetGenerator](#using-the-datasetgenerator)
    - [Example of a dataset definition file](#example-of-a-dataset-definition-file)
    - [Example of a sequence file](#example-of-a-sequence-file)

## Getting Started
### Installing from Source
You can build and install this application from source by using CMake and a C++ compiler. The CMake Project will be built automatically, but will take some time.

#### Prerequisites
- C++20 Compiler
  - g++ or clang for Linux
  - MSVC or clang from Visual Studio 2022 for Windows
- CMake >= 3.30
- Python >= 3.10
- Geant4 11.0.0
- Optional:
    - OpenGL

Just execute CMake on the CMakeLists.txt from the root of the project and set the following CMake arguments:
- *WITH_GEANT4_UIVIS* (`ON`/`OFF`): Specify, if the OpenGL visualizer shall be used. If enabled, RadField3D will **not** use Multiprocessing, but show a Window where the paths of each particle can be viewed. Else, On window will be displayed, but the application will use all available cores.
- *PYTHON_VERSION* (`x.yy`): The present or desired python version. If no matching version can be found CMake will try to find at least an existing python installation an throw a warning.
- *RS_Use_Conda* (`ON`/`OFF`): Toggle explicit conda environment usage on or off.
- *RS_USE_ANACONDA_ENV_NAME*: If `RS_Use_Conda=ON`, specify the conda environment name.
- *ASSIMP_BUILD_ZLIB* (`ON`/`OFF`): Specify, if the zlib library should be built by this project or if an already existing version should be used.

## Generating Datasets
Datasets can be generated by calling RadField3D multiple times or using the [DatasetGenerator](tools/create_dataset.py) written in Python. The spectra loading from the python DataGenerator requires pyTorch.

### Directly using RadField3D
The commandline interface of RadField3D can be printed by calling: `./RadField3D --help` or `.\RadField3D.exe --help`.

The parameters are the following:
- *out*: The output path of the apllication. Must end with `.rf3` otherwise the extension will be added.
- *max-energy*: Maximum energy to consider for the energy spectrum in each voxel. Value must be given in eV.
- *source-alpha*: The rotation in degree inside the horizontal plane.
- *source-beta*: The rotation in degree inside the vertical plane.
- *source-distance*: Radius of the roation sphere in meter (Equals the distance of the source from the center of the scene).
- *world-dim*: Dimensions of the World in meter provided as a string looking like this: "x y z". The used source can be located outside this tracking volume.
- *particles*: Maximum count of particles (photons) to track.
- *voxel-dim*: Dimensions of each voxel along each dimension in meter. Voxels are supposed to be cubes, hence this parameter only accepts one float value.
- *energy-resolution*: The used energy resolution in eV that should be used as the bin width when scoring photon energy spectra.
- *source-shape*: The used source shape to sample rays from. Can be one of: `cone`, `rectangle` or `ellipsoid`.
- *source-opening-angle*: The opening angle to use for the ray sampling from the source.
  - For `cone`: One single value for the half opening angle in degrees.
  - For `ellipsoid`: Two values for the half opening angle in degrees and in each direction.
  - For `rectangle`: Two values for the rectangle extents in meter in `source-distance` meter away from the source (so in the center of the scene).
- *tracing-algorithm*: The used algorithm to find intersected voxels for a given particle path. Can be one of `sampling`, `bresenham` or `linetracing`.
- *geom*: The path to the geometry file. The geoemetry can be provided by all file formats supported by Assimp like `.obj`, `.fbx` or `.stl`. For each geometry file, one can specify a world scene description file named with the pattern: `[base-file-name].desc` on the same folder as the geoemtry file.
- *spectrum*: The path to a x-ray spectrum in .csv-format. The CSV-file should have the form column 1: Energy-Bin-Edge starting from 0eV and column 2: relative photon counts for this bin. The input distribution will be normalized to a integral of one.


#### Geometry world description file
The geometry description file contains the information how the meshes of the geometry file are nested inside eachother and which material each mesh volume has. Additionally, a transformation for each mesh can be supplied. The file shoud have the JSON-Format.
Example:
```json
{
    "mesh_name": {
        "MaterialName": "G4_TISSUE_SOFT_ICRU",
        "Patient": true, // can only be true for one mesh
        "Transform": {
            "Rotation": {
                "X": 0,
                "Y": 3.14159265359,
                "Z": 0.0
            },
            "Translation": {
                "X": 0.0,
                "Y": 0.0,
                "Z": 0.0
            },
            "Scale": {
                "X": 1.0,
                "Y": 1.0,
                "Z": 1.0
            }
        }
        "Children": {
            "child_name_name": {
                "Patient": false,
                "MaterialName": "G4_LUNG_ICRP",
                "Transform": {
                    "Rotation": {
                        "X": 0,
                        "Y": 0.0,
                        "Z": 0.0
                    },
                    "Translation": {
                        "X": 0.0,
                        "Y": 0.0,
                        "Z": 0.0
                    },
                    "Scale": {
                        "X": 1,
                        "Y": 1,
                        "Z": 1
                    }
                }
            },
        }
    }
}
```
With `mesh_name` and `child_name_name` name being the name of the mesh as exported by the geometry file. MaterialName can be one of the Geant4 Materials, but it is more error prune as `Water` will be corrected to `G4_WATER`, if the prior was not a valid material.

### Using the DatasetGenerator
After installing the needed pyTorch (CPU or CUDA version doesn't matter), one can call the DatasetGenerator from `./tools/create_dataset.py`. The arguments are working similar like the direct RadField3D parameters, but slightly extended.

Parameters:
- *dest*: Distination path to a folder, where the fields will be stored to.
- *fields*: Number of fields to calculate.
- *Emin*: Only use when no Spectra are defined. Specifies the lower end of the source energy sampling in eV.
- *Emax*: Specifies the upper end of the source energy sampling in eV. Which will be used for the upper bound of the voxel spectra stored.
- *particles*: Maximum count of particles (photons) to track.
- *geometry*: The path to the geometry file. The geoemetry can be provided by all file formats supported by Assimp like `.obj`, `.fbx` or `.stl`. For each geometry file, one can specify a world scene description file named with the pattern: `[base-file-name].desc` on the same folder as the geoemtry file. See the previous example of the world description file.
- *voxel_size*: Dimensions of each voxel along each dimension in meter. Voxels are supposed to be cubes, hence this parameter only accepts one float value.
- *world_size*: Dimensions of the World in meter provided as a string looking like this: "x y z". The used source can be located outside this tracking volume.
- *binary*: Path to the RadField3D binary to execute.
- *spectra*: path to a single spectra file or folder containing multiple spectra to sample one spectrum from. Single spectrum files can be .csv-files like described prior or .spectrum-files that will be loaded as torch tensors. Used spectrum files will be copied in to the destination file and linked with the radiation field files.
- *source_distance*: Radius of the roation sphere in meter (Equals the distance of the source from the center of the scene).
- *source_shape*: The used source shape to sample rays from. Can be one of: `cone`, `rectangle` or `ellipsoid`.
- *source_angles*: The angles from which the source is facing the center (alpha and beta angle in degree).
- *source_opening_angle*: The opening angle to use for the ray sampling from the source.
  - For `cone`: One single value for the half opening angle in degrees.
  - For `ellipsoid`: Two values for the half opening angle in degrees and in each direction.
  - For `rectangle`: Two values for the rectangle extents in meter in `source-distance` meter away from the source (so in the center of the scene).
- *clean*: Issues to first remove all radiation field files that already exist and do not append to them.
- *bin_count*: Sets the energy resolution according to the desired bin count and maximum energy.
- *tracer_algorithm*: The used algorithm to find intersected voxels for a given particle path. Can be one of `sampling`, `bresenham` or `linetracing`.
- *sequence_file*: Optional: Allows to load some of the options sequentially from a JSON-File to automate specific dataset configurations under specified conditions.
- *cluster_node_partition*: Optional. Only used when `sequence_file` is set. Allows to determine which  section of a sequence file should be processed by this process. Useful when multiple instances are run on a cluster. Specify in the form of: "m" "n" where n is the current node ID ([0..(m-1)]) and m is the total node count.
- *dataset_definition*: Provide the path to a JSON file containing a whole dataset generation definition. This overrdides all other parameters except for `--dest`, `--binary` and `--cluster_node_partition`. An Example can be found below.

#### Example of a dataset definition file
```json
{
    "Metaparameters": {
        "MaxEnergy": 1.5e+4,
        "GeometryFile": "<path-to-a-geometry-file.obj>",
        "Particles": 200000,
        "TracerAlgorithm": "linetracing",
        "BinCount": 32,
        "WorldDim": [1, 1, 1],
        "VoxelSize": 0.02,
        "nSamples": 500
    },
    "Parameters": [
        {
            "name": "source_distance",
            "values": [2.5, 2.0, 1.5]   // This is a list to sample randomly from
        },
        {
            "name": "source_angle_alpha",
            "range": [-90, 90]          // This is a range to sample uniform within
        },
        {
            "name": "source_angle_beta",
            "value": 0                  // This is a fixed values that never changes
        },
        {
            "name": "source_opening_angle",
            "values": 5
        },
        {
            "name": "source_shape",
            "value": "cone"
        },
        {
            "name": "source_spectra",
            "value": "<path-to-a-spectra-file-or-folder>.spectra/.csv"
        }
    ]
}
```

#### Example of a sequence file
```json
{
    "Metaparameters": {
        "MaxEnergy": 1.5e+4,
        "GeometryFile": "<path-to-a-geometry-file.obj>",
        "Particles": 200000,
        "TracerAlgorithm": "linetracing",
        "BinCount": 32,
        "WorldDim": [1, 1, 1],
        "VoxelSize": 0.02
    },
    "ParameterSets": [
        [
            {
                "name": "source_distance",
                "value": 2.5
            },
            {
                "name": "source_angle_alpha",
                "value": 0
            },
        ],
        [
            {
                "name": "source_distance",
                "value": 2.0
            },
            {
                "name": "source_angle_alpha",
                "value": 0
            },
        ],
        [
            {
                "name": "source_distance",
                "value": 1.5
            },
            {
                "name": "source_angle_alpha",
                "value": 0
            },
        ]
    ]
}
```
